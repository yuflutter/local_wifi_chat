# Настройка аудио-комнаты

## Установка зависимостей

1. Установите зависимости Flutter:
```bash
flutter pub get
```

## Запуск бекенда (заглушка)

1. Перейдите в директорию с бекендом:
```bash
cd backend_mock
```

2. Установите зависимости Go:
```bash
go mod download
```

3. Запустите сервер:
```bash
go run main.go
```

Сервер будет доступен на `ws://localhost:8080/audio`

## Запуск Flutter приложения

1. Запустите приложение в режиме web:
```bash
flutter run -d chrome --web-browser-flag "--disable-web-security"
```

Флаг `--disable-web-security` необходим для работы с микрофоном в режиме разработки.

## Использование

1. Откройте приложение в браузере
2. Перейдите на вкладку "Аудио"
3. В диалоге подключения:
   - URL сервера: `ws://localhost:8080/audio`
   - Введите ваше имя
   - Нажмите "Подключиться"
4. Нажмите на большую кнопку микрофона для включения/выключения микрофона
5. Регулируйте громкость других участников с помощью слайдеров

## Тестирование с несколькими клиентами

Откройте несколько вкладок браузера с приложением и подключитесь с разными именами.

## Архитектура

### Клиент (Flutter Web)

- **Models**: Модели данных для участников и сообщений
- **Services**: 
  - `AudioRoomService` - управление WebSocket соединением
  - `AudioPlayerService` - воспроизведение аудио от других участников
  - `AudioRecorderService` - запись аудио с микрофона
- **Providers**: `AudioRoomProvider` - управление состоянием приложения
- **View/Widgets**: UI компоненты

### Сервер (Go)

- MCU архитектура без микширования
- Пересылка аудио-потоков всем участникам кроме источника
- Управление списком участников
- Рассылка метаданных

## Протокол WebSocket

### Текстовые сообщения (JSON)

**Подключение:**
```json
{
  "type": "metadata",
  "data": {
    "action": "join",
    "userId": "unique-id",
    "userName": "User Name"
  }
}
```

**Обновление статуса:**
```json
{
  "type": "participant_update",
  "data": {
    "userId": "user-id",
    "isMuted": true
  }
}
```

**Список участников (от сервера):**
```json
{
  "type": "metadata",
  "data": {
    "participants": [
      {
        "id": "user-id",
        "name": "User Name",
        "isMuted": false,
        "isSpeaking": false,
        "volume": 1.0
      }
    ]
  }
}
```

### Бинарные сообщения (аудио)

Формат: `[36 байт ID участника][аудио данные WebM/Opus]`

## Особенности реализации

- Микширование аудио происходит в браузере (Web Audio API)
- Каждый участник может регулировать громкость других участников независимо
- Сервер не обрабатывает аудио, только пересылает
- Низкая задержка благодаря отправке чанков каждые 100ms
- Автоматическое переподключение при разрыве соединения

## Требования

- Flutter SDK 3.10.3+
- Go 1.21+
- Современный браузер с поддержкой WebRTC и Web Audio API
- Микрофон для записи аудио
